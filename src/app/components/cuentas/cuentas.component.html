<!-- cuentas.component.html -->
<div class="container">
  <div class="card">
    <h2>Lista de Cuentas</h2>
    <div class="button-container">
      <button mat-raised-button color="primary" (click)="openRegisterForm()">
        Nueva Cuenta
      </button>
    </div>

    <div *ngIf="showRegisterForm" class="register-form-overlay">
      <div class="register-form-container">
        <h2>{{ editMode ? "Editar" : "Registrar" }} Cuenta</h2>
        <form [formGroup]="registerForm" (ngSubmit)="onSubmit()">
          <div class="form-grid">
            <div class="form-grid-item">
              <mat-form-field appearance="fill">
                <mat-label>Nombre del Titular</mat-label>
                <input matInput formControlName="nombre_titular" required />
              </mat-form-field>
            </div>
          </div>
          <div class="form-actions">
            <button
              mat-button
              type="button"
              class="cancel"
              (click)="closeRegisterForm()"
            >
              Cancelar
            </button>
            <button mat-button type="submit" color="primary">
              {{ editMode ? "Actualizar" : "Registrar" }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <div *ngIf="showAddServicioForm" class="register-form-overlay">
      <div class="register-form-container">
        <h2>Añadir Servicios a la Cuenta</h2>
        <form [formGroup]="addServicioForm" (ngSubmit)="onAddServicioSubmit()">
          <div class="form-grid">
            <div class="form-grid-item">
              <mat-form-field appearance="fill">
                <mat-label>Servicios</mat-label>
                <mat-select formControlName="servicios" multiple required>
                  <mat-option
                    *ngFor="let servicio of servicios"
                    [value]="servicio.id_service"
                  >
                    {{ servicio.nombre }}
                  </mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
          <div class="form-actions">
            <button
              mat-button
              type="button"
              class="cancel"
              (click)="closeAddServicioForm()"
            >
              Cancelar
            </button>
            <button mat-button type="submit" color="primary">
              Añadir Servicios
            </button>
          </div>
        </form>
      </div>
    </div>

    <div *ngIf="showAddProductoForm" class="register-form-overlay">
      <div class="register-form-container">
        <h2>Añadir Productos a la Cuenta</h2>
        <form [formGroup]="addProductoForm" (ngSubmit)="onAddProductoSubmit()">
          <div formArrayName="productos" class="form-grid">
            <div
              *ngFor="
                let producto of productosFormArray.controls;
                let i = index
              "
              [formGroupName]="i"
              class="form-grid-item"
            >
              <mat-form-field appearance="fill">
                <mat-label>Producto</mat-label>
                <mat-select formControlName="sku" required>
                  <mat-optgroup label="Productos">
                    <mat-option
                      *ngFor="let producto of productos"
                      [value]="producto.SKU"
                    >
                      {{ producto.nombre }}
                    </mat-option>
                  </mat-optgroup>
                  <mat-optgroup label="Productos Preparados">
                    <mat-option
                      *ngFor="let producto of productosPreparados"
                      [value]="producto.SKU"
                    >
                      {{ producto.nombre }}
                    </mat-option>
                  </mat-optgroup>
                </mat-select>
              </mat-form-field>
              <mat-form-field appearance="fill">
                <mat-label>Cantidad</mat-label>
                <input
                  matInput
                  formControlName="cantidad"
                  type="number"
                  required
                  min="1"
                />
              </mat-form-field>
              <button mat-icon-button color="warn" (click)="removeProducto(i)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
          <button
            mat-raised-button
            color="accent"
            (click)="addProducto()"
            type="button"
          >
            Agregar Producto
          </button>
          <div class="form-actions">
            <button
              mat-button
              type="button"
              class="cancel"
              (click)="closeAddProductoForm()"
            >
              Cancelar
            </button>
            <button mat-button type="submit" color="primary">
              Añadir Productos
            </button>
          </div>
        </form>
      </div>
    </div>

    <div *ngIf="showPaymentDetail" class="payment-detail-overlay">
      <div class="payment-detail-container" id="payment-detail">
        <h2>Detalles del Pago</h2>
        <div class="payment-section">
          <h3>{{ paymentDetail?.productos?.concepto }}</h3>
          <p>
            <strong>Titular:</strong> {{ paymentDetail?.productos?.titular }}
          </p>
          <p><strong>Total:</strong> {{ paymentDetail?.productos?.total }}</p>
          <div *ngFor="let item of paymentDetail?.productos?.detalle">
            <p><strong>Producto:</strong> {{ item.producto }}</p>
            <p><strong>Cantidad:</strong> {{ item.cantidad }}</p>
            <p><strong>Precio Unitario:</strong> {{ item.precio_unitario }}</p>
            <p><strong>Total:</strong> {{ item.total }}</p>
          </div>
        </div>
        <div class="payment-section">
          <h3>{{ paymentDetail?.servicios?.concepto }}</h3>
          <p>
            <strong>Titular:</strong> {{ paymentDetail?.servicios?.titular }}
          </p>
          <p><strong>Total:</strong> {{ paymentDetail?.servicios?.total }}</p>
          <div *ngFor="let item of paymentDetail?.servicios?.detalle">
            <p><strong>Servicio:</strong> {{ item.servicio }}</p>
            <p>
              <strong>Tiempo de Utilización:</strong>
              {{ item.tiempo_utilizacion }}
            </p>
            <p><strong>Precio Unitario:</strong></p>
            <ul>
              <li *ngFor="let precio of item.precio_unitario">
                {{ precio.unidad }}: {{ precio.precio }}
              </li>
            </ul>
            <p><strong>Total:</strong> {{ item.total }}</p>
          </div>
        </div>
        <div class="form-actions">
          <button
            mat-button
            type="button"
            class="cancel"
            (click)="closePaymentDetail()"
          >
            Cerrar
          </button>
          <button
            mat-button
            type="button"
            color="primary"
            (click)="imprimirDetalle()"
          >
            Imprimir
          </button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
        <ng-container matColumnDef="titular">
          <th mat-header-cell *matHeaderCellDef>Titular</th>
          <td mat-cell *matCellDef="let cuenta">{{ cuenta.titular }}</td>
        </ng-container>

        <ng-container matColumnDef="fecha_apert">
          <th mat-header-cell *matHeaderCellDef>Fecha de Apertura</th>
          <td mat-cell *matCellDef="let cuenta">
            {{ cuenta.fecha_apert | date }}
          </td>
        </ng-container>

        <ng-container matColumnDef="estado">
          <th mat-header-cell *matHeaderCellDef>Estado</th>
          <td mat-cell *matCellDef="let cuenta">{{ cuenta.estado }}</td>
        </ng-container>

        <ng-container matColumnDef="acciones">
          <th mat-header-cell *matHeaderCellDef>Acciones</th>
          <td mat-cell *matCellDef="let cuenta">
            <button
              mat-icon-button
              color="primary"
              (click)="openEditForm(cuenta)"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              color="warn"
              (click)="deleteCuenta(cuenta.id_cuenta)"
            >
              <mat-icon>delete</mat-icon>
            </button>
            <button
              mat-icon-button
              color="accent"
              (click)="openAddServicioForm(cuenta.id_cuenta)"
            >
              <mat-icon>add</mat-icon>
            </button>
            <button
              mat-icon-button
              color="accent"
              (click)="openAddProductoForm(cuenta.id_cuenta)"
            >
              <mat-icon>add</mat-icon>
            </button>
            <button
              mat-icon-button
              color="accent"
              (click)="pagarCuenta(cuenta.id_cuenta)"
            >
              <mat-icon>payment</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      <div *ngIf="dataSource.data.length === 0" class="empty-state">
        No hay cuentas disponibles.
      </div>
    </div>
  </div>
</div>
